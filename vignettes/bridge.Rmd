---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE}
knitr::opts_chunk$set(collapse  = TRUE,
                      comment   = "#>",
                      out.width = "100%",
                      dpi       = 96,
                      fig.align = "center")
```


The aim of the package `bridge` is to provide tools to work with directed spatial
networks. It allows users to easily create and visualize network objects, 
like nodes and edges lists, connectivity matrix, edges weighting matrix, spatial 
weight matrix, nodes by edges matrix, etc. These objects can be used later in 
spatial multivariate analyses: Moran's Eigenvector Maps (MEM, Dray _et al._ 2006) and 
Asymetric Eigenvector Maps (AEM, Blanchet _et al._ 2008) available in the package
[`adespatial`](https://cran.r-project.org/package=adespatial) (Dray _et al._ 2022).

This package has been developed for the 
[FRB-CESAB](https://www.fondationbiodiversite.fr/en/about-the-foundation/le-cesab/) 
working group 
[Bridge](https://www.fondationbiodiversite.fr/en/the-frb-in-action/programs-and-projects/le-cesab/bridge/) 
that aims to better understand the role of local and regional environmental 
factors in shaping the taxonomic and functional diversity of plant communities 
established along river corridors, roadside corridors and cultivated field 
margins.


\


```{r 'setup'}
library("bridge")
library("ggplot2")
```


\


First let's define a custom theme for the `ggplot2` visualizations.


```{r 'ggplot-theme'}
custom_theme <- function() {
  theme_light() + 
  theme(plot.title   = element_text(face = "bold", family = "serif", size = 18),
        plot.caption = element_text(face = "italic", family = "serif"),
        axis.title   = element_blank(),
        axis.text    = element_text(family = "serif"))
}
```


\


## Provided data



The package `bridge` comes with two datasets:

- **Adour river**, an `sf` spatial object of type `LINESTRING` providing the 
geometry of the French river _L'Adour_;
- **Adour sites**, a `data.frame` with sites labels and sites coordinates along
the river.


\


### Adour river



Let's import the **Adour river** spatial layer.


```{r 'import-adour-river'}
# Import the spatial layer of Adour river ----
path_to_file <- system.file("extdata", "adour_lambert93.gpkg", package = "bridge")
adour_river  <- sf::st_read(path_to_file, quiet = TRUE)

head(adour_river)
```

This layer is an [`sf`](https://cran.r-project.org/package=sf) spatial object 
of type `LINESTRING` and contains one single row (geometry) defined in the 
[RGF93 / Lambert-93](https://epsg.io/2154) projection.


\


Now let's import a base map of France to locate the Adour river using the package
[`rnaturalearth`](https://cran.r-project.org/package=rnaturalearth).


```{r 'get-basemap'}
# Import France departments ----
france <- rnaturalearth::ne_states("france", returnclass = "sf")

# Remove overseas territories ----
france <- france[grep("^FR\\.", france$"code_hasc"), ]

# Project layer to RGF93 / Lambert-93 system ----
france <- sf::st_transform(france, sf::st_crs(adour_river))
```


\


Let's locate the Adour river of the France map.


```{r 'map-adour-river', fig.height=10, fig.width=10, out.width='80%'}
# Get extent of Adour river ----
adour_extent <- sf::st_bbox(adour_river)
adour_extent <- adour_extent + c(-10000, -10000, 10000, 10000)

ggplot() +
  geom_sf(data = france, fill = "lightgray", col = "white", size = 0.2) +
  geom_sf(data = adour_river, col = "steelblue") +
  geom_sf(data = sf::st_as_sfc(adour_extent), fill = NA, size = 0.3) +
  labs(title   = "The French river Adour", 
       caption = "RGF93 / Lambert-93 Projection") +
  custom_theme()
```


\


### Adour sites



Let's import the **Adour sites** data representing survey sites around the Adour.


```{r 'import-adour-sites'}
## Import the dataset of sites ----
path_to_file <- system.file("extdata", "adour_sites_coords.csv", 
                            package = "bridge")
adour_sites  <- read.csv(path_to_file)
adour_sites
```


This `data.frame` contains three columns: the site label and sites coordinates
defined in the [RGF93 / Lambert-93](https://epsg.io/2154) projection.



\


Let's convert this `data.frame` into an `sf` object of type `POINT`.

```{r 'df-to-sf', fig.height=10, fig.width=12}
# Convert data.frame to sf object ----
adour_sites_sf <- sf::st_as_sf(adour_sites, coords = 2:3, crs = "epsg:2154")
adour_sites_sf
```


\


Finally, let's map these sites and the Adour river.


```{r 'map-adour-sites', fig.height=10, fig.width=12, out.width='80%'}
ggplot() +
  geom_sf(data = adour_river, col = "steelblue") +
  geom_sf(data = adour_sites_sf, shape = 19, size = 3) +
  geom_label(data = adour_sites, aes(x = longitude, y = latitude, label = site), 
            size = 4.2, nudge_x = 5000, family = "serif") +
  labs(title   = "Study area (French river Adour)", 
       caption = "RGF93 / Lambert-93 Projection") +
  custom_theme() +
  geom_segment(aes(x = 454180, xend = 440170, y = 6216290, yend = 6263320), 
               arrow = arrow(length = unit(0.75, 'cm'), type = 'closed'),
               size  = 2.25)
```


\


## Nodes and Edges


The first information to extract from our spatial network is 
1) the nodes (sites) list and 
2) the edges (links) list between nodes.


\


### Nodes list

First, let's identify the **nodes list**, i.e. a vector of unique ordered sites 
labels.


\


**Important:** as the sites have a direction (along the Adour river, from 
upstream to downstream), the order of the sites must be found in the sites labels.

For instance, in the Adour sites dataset, sites are labelled as **S-01**, **S-02**, 
..., **S-10**. This means that the most upstream site is **S-01** and the
most downstream is **S-10**.


\


But be aware that ordering characters can have some unwanted effects, especially if 
they contain numbers.

For instance,

```{r 'order-labels'}
# Alphanumerical ordering ----
sites <- c( "s1",  "s2", "s11", "s10")
sort(sites)

# Natural ordering ----
sites <- c("s01", "s02", "s11", "s10")
sort(sites)
```

You may want to code your sites as in the second example, i.e. based on a 
**Natural ordering**.


\


Let's use the function `nodes_list()` to 1) retrieve the unique labels of sites,
and to 2) order them along the Adour river (from upstream to downstream).


```{r 'nodes-list'}
adour_nodes <- nodes_list(adour_sites$"site")
adour_nodes
```


\


### Edges list


From this nodes list, we can create an **edges list**, i.e. a table describing 
links between nodes. Several methods exist to identify spatial neighbors and
most of them are available in the package 
[`spdep`](https://cran.r-project.org/package=spdep) (Bivand _et al._ 2022).


\


Here we implement our own method to detect spatial neighbors based sites labels 
and a degree of neighborhood. As our sites are ordered along the Adour river, if
we use a degree **1** of neighborhood, a site will be linked to the first next site 
(upstream) and also to the first previous site (downstream). If we use a degree 
**2** of neighborhood, a site will be linked to the two next sites 
(upstream) and also to the two previous sites (downstream). And so on.


\


Let's create this edges list with the function `edges_list()`.

```{r 'edges-list'}
# List of edges with degree 1 of neighborhood ----
adour_edges <- edges_list(adour_nodes, degree = 1)
adour_edges
```

This `data.frame` contains four columns:

- `edge_id`: label of the edge
- `edge`: 0 (no edge) or 1 (edge), useful if `all = TRUE` (see below)
- `from`: label of the most upstream node of the edge
- `to`: label of the most downstream node of the edge

\


The function `edges_list()` has three additional arguments:

- `self`: if `TRUE`, a node can be linked to itself. Default is `FALSE`.
- `all`: if `TRUE`, the missing edges are also returned. Default is `FALSE`.
- `directed`: if `FALSE` (default), symmetrical edges (e.g. `S01-S02` and `S02-S01`) 
are returned (_undirected network_). Otherwise (_directed network_) only the 
first edge (e.g. `S01-S02`) is returned (according to the direction of the nodes labels).


\


**Tips: ** if you want to use Moran's Eigenvector Maps (MEM) use `directed = FALSE`.
If you want to use Asymetric Eigenvector Maps (AEM) use `directed = TRUE`.


\


Let's use this function `edges_list()` in a directed way.

```{r 'edges-list-directed'}
# List of edges with degree 1 of neighborhood (directed network) ----
adour_edges <- edges_list(adour_nodes, degree = 1, directed = TRUE)
adour_edges
```


\


### Visualizing edges


The package `bridge` provides a convenient function to convert this edges list 
table to an `sf` object of type `LINESTRING`: `edges_to_sf()`.


\


Let's convert the edges list to a spatial object.

```{r 'edges-to-sf'}
# Convert edges list to sf object ----
adour_edges_sf <- edges_to_sf(adour_edges, adour_sites_sf)
adour_edges_sf
```


\


Let's add these edges to our map.


```{r 'map-adour-edges', fig.height=10, fig.width=12, out.width='80%'}
ggplot() +
  geom_sf(data = adour_river, col = "darkgray") +
  geom_sf(data = adour_edges_sf) +
  geom_sf(data = adour_sites_sf, shape = 19, size = 3) +
  labs(title   = "Edges with degree 1 of neighborhood", 
       caption = "RGF93 / Lambert-93 Projection") +
  custom_theme()
```


\


Finally, let's increase the degree of neighborhood.


```{r 'edges-degree-3'}
# List of edges with degree 3 of neighborhood ----
adour_edges <- edges_list(adour_nodes, degree = 3, directed = TRUE)

# Convert edges list to sf object ----
adour_edges_sf <- edges_to_sf(adour_edges, adour_sites_sf)
```

```{r 'map-adour-edges-3', fig.height=10, fig.width=12, out.width='80%'}
ggplot() +
  geom_sf(data = adour_river, col = "darkgray") +
  geom_sf(data = adour_edges_sf) +
  geom_sf(data = adour_sites_sf, shape = 19, size = 3) +
  labs(title   = "Edges with degree 3 of neighborhood", 
       caption = "RGF93 / Lambert-93 Projection") +
  custom_theme()
```


\


## Connectivity matrix

We can convert the edges list to a connectivity matrix (also called adjacency matrix) 
by using the function `adjacency_matrix()`.

```{r 'connectivity-matrix'}
# List of edges with degree 3 of neighborhood ----
adour_edges <- edges_list(adour_nodes, degree = 1, directed = TRUE)

# Create connectivity matrix ----
adour_edges_mat <- adjacency_matrix(adour_edges)
adour_edges_mat
```


\


## References

Bivand R. _et al._ (2022) spdep: Spatial dependence, weighting schemes, and statistics.
R package version 1.2-4, 
[https://CRAN.R-project.org/package=spdep](https://CRAN.R-project.org/package=spdep).

Blanchet F. G., Legendre P. & Borcard D. (2008) Modelling directional spatial 
processes in ecological data. **Ecological Modelling**, 215, 325-336. 
doi: [10.1016/j.ecolmodel.2008.04.001](https://doi.org/10.1016/j.ecolmodel.2008.04.001).

Dray S., Legendre P. & Peres-Neto P. R. (2006) Spatial modelling: a comprehensive 
framework for principal coordinate analysis of neighbour matrices (PCNM).
**Ecological Modelling**, 196, 483-493. 
doi: [10.1016/j.ecolmodel.2006.02.015](https://doi.org/10.1016/j.ecolmodel.2006.02.015).

Dray S. _et al._ (2022) adespatial: Multivariate Multiscale Spatial Analysis. 
R package version 0.3-16, 
[https://CRAN.R-project.org/package=adespatial](https://CRAN.R-project.org/package=adespatial).
