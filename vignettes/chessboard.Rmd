---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE}
knitr::opts_chunk$set(collapse  = TRUE,
                      comment   = "#>",
                      out.width = "100%",
                      dpi       = 96,
                      fig.align = "center")
```


The aim of the package `chessboard` is to provide tools to work with **directed**
(asymmetric) and **undirected** (symmetrical) spatial **networks**.
It makes easier the creation of **connectivity matrix**, i.e. a binary matrix 
of dimensions `n x n`, where `n` is the number of **nodes** (sampling units) 
indicating the presence (`1`) or the absence (`0`) of an **edge** (link) 
between pairs of nodes. Different network objects can be produced by `chessboard`:

- **nodes list**
- **neighbors list**
- **edges list**
- **connectivity matrix**


\


In addition, the package can also produce objects that can be used later in 
Asymetric Eigenvector Maps (AEM, Blanchet _et al._ 2008), method available in 
the package [`adespatial`](https://cran.r-project.org/package=adespatial) (Dray _et al._ 2022):
**nodes by edges matrix** and **edges weights vector**.


\


This package has been developed for the 
[FRB-CESAB](https://www.fondationbiodiversite.fr/en/about-the-foundation/le-cesab/) 
working group 
[Bridge](https://www.fondationbiodiversite.fr/en/the-frb-in-action/programs-and-projects/le-cesab/bridge/) 
that aims to better understand the role of local and regional environmental 
factors in shaping the taxonomic and functional diversity of plant communities 
established along river corridors, roadside corridors and cultivated field 
margins.


\


**Setup**



```{r 'setup'}
# devtools::load_all()
library("chessboard")
library("ggplot2")
```



```{r 'ggplot-theme', echo=FALSE}
## Custom ggplot2 theme ----
custom_theme <- function() {
  theme_light() + 
  theme(plot.title   = element_text(face = "bold", family = "serif", size = 18),
        plot.caption = element_text(face = "italic", family = "serif"),
        axis.title   = element_blank(),
        axis.text    = element_text(family = "serif"))
}
```


\


## Sampling design



The package `chessboard` is designed to work with **two-dimensional network** (i.e. 
sampling on a regular grid). The network can be spatial or not, and can be 
directed or undirected.

`chessboard` provides an example of a survey realized along the French river
_L'Adour_ (Fig. 1).

```{r 'import-adour-river', echo=FALSE}
## Import the spatial layer of Adour river ----
path_to_file <- system.file("extdata", "adour_lambert93.gpkg", package = "chessboard")
adour_river  <- sf::st_read(path_to_file, quiet = TRUE)
```

```{r 'get-basemap', echo=FALSE}
## Import France departments ----
france <- rnaturalearth::ne_states("france", returnclass = "sf")

## Remove overseas territories ----
france <- france[grep("^FR\\.", france$"code_hasc"), ]

## Project layer to RGF93 / Lambert-93 system ----
france <- sf::st_transform(france, sf::st_crs(adour_river))
```


\


```{r 'map-adour-river', echo=FALSE, fig.height=9, fig.width=10, out.width='80%', fig.cap='Figure 1. Location of the French river L\'Adour'}
## Get extent of Adour river ----
adour_extent <- sf::st_bbox(adour_river)

## Add some margin around ----
adour_extent <- adour_extent + c(-10000, -10000, 10000, 10000)

ggplot() +
  geom_sf(data = france, fill = "lightgray", col = "white", size = 0.2) +
  geom_sf(data = adour_river, col = "steelblue") +
  geom_sf(data = sf::st_as_sfc(adour_extent), fill = NA, size = 0.3) +
  labs(caption = "RGF93 / Lambert-93 Projection") +
  custom_theme() +
  geom_text(aes(x = 194015, y = 6453703), label = "Atlantic\nOcean",
            color = "lightgray", fontface = "italic", size = 6, 
            family = "serif") +
  geom_text(aes(x = 482630, y = 6150836), label = "Pyrenees",
            color = "lightgray", fontface = "italic", size = 6, 
            family = "serif")
```


\


_L'Adour_ is a river in southwestern France. It rises in the Pyrenees and 
flows into the Atlantic Ocean (Bay of Biscay). It's oriented from south-east 
(upstream) to north-west (downstream).


\


Along this river, a survey has been realized at **three** locations (Fig. 2).
At each location, a sampling has been conducted on a regular grid composed of 
**three** transects each of them composed of **five** quadrats.


\


```{r 'import-adour-sites', echo=FALSE}
## Import sites data ----
path_to_file <- system.file("extdata", "adour_survey_sampling.csv", package = "chessboard")
adour_sites  <- read.csv(path_to_file)

## Convert data.frame to sf object ----
adour_sites_sf <- sf::st_as_sf(adour_sites, coords = c("longitude", "latitude"), 
                               crs = "epsg:2154")
```


```{r 'map-adour-sites', fig.height=9, fig.width=12, out.width='80%', echo=FALSE, fig.cap='Figure 2. Study area with survey sampling'}
ggplot() +
  geom_sf(data = adour_river, col = "steelblue") +
  geom_sf(data = adour_sites_sf, shape = 19, size = 2) +
  labs(caption = "RGF93 / Lambert-93 Projection") +
  custom_theme() +
  geom_segment(aes(x = 454180, xend = 440170, y = 6216290, yend = 6263320), 
               arrow = arrow(length = unit(0.75, 'cm'), type = 'closed'),
               size  = 2.25) +
  geom_text(aes(x = 334500, y = 6285000), label = "River", hjust = 0,
            color = "steelblue", fontface = "bold", size = 6, family = "serif") +
  geom_text(aes(x = 414950, y = 6312200), label = "Location 3", hjust = -0.20,
            color = "black", fontface = "bold", size = 6, family = "serif") +
  geom_text(aes(x = 474655, y = 6236708), label = "Location 1", 
            color = "black", fontface = "bold", size = 6, family = "serif") +
  geom_text(aes(x = 467250, y = 6287620), label = "Location 2", 
            color = "black", fontface = "bold", size = 6, family = "serif")
```


\


The arrow indicates the direction of the river flow. This means that our 
sampling design is a **directed spatial network** (both inside a location and
between locations) where the main direction is from upstream to downstream. 


\

**N.B.** The package `chessboard` can also deal with one-dimensional sampling 
(either **transects-only** or **quadrats-only**) and with **undirected** networks.


\


## Nodes labeling


It's **important** to note that, even the package `chessboard` can handle spatial 
networks, it does not explicitly use spatial coordinates to find neighbors (and edges). 
Instead, it will identify neighbors only based on **nodes labels**. In other 
words, the order of nodes labels will give the dimension and the direction of 
the network.


\

Let's import the survey dataset provided by the package.

```{r 'import-adour-survey'}
## Import survey data ----
path_to_file <- system.file("extdata", "adour_survey_sampling.csv", package = "chessboard")
adour_sites  <- read.csv(path_to_file)

head(adour_sites, 20)
```

This `data.frame` contains the following columns: 

- `location`: the identifier of the location (`numeric`)
- `transect`: the identifier of the transect (`numeric`)
- `quadrat`: the identifier of the quadrat (`numeric`)
- `longitude`: the longitude of the site (**node**) defined in the [RGF93 / Lambert-93](https://epsg.io/2154) projection
- `latitude`: the latitude of the site (**node**) defined in the [RGF93 / Lambert-93](https://epsg.io/2154) projection


\


**N.B.** The column `location` is optional (if the survey has been conducted at one single location).
If the network has one dimension, one of the columns `transect` and `quadrat` can
be omitted.


\


We can visualize this survey on a Cartesian referential, i.e. non-spatial, where
the x-axis corresponds to **transects** and the y-axis represents the **quadrats**
(Fig. 3).


\


```{r 'plot-sampling-units', fig.height=8, fig.width=12, echo=FALSE, out.width='100%', fig.cap='Figure 3. Sampling design'}
locations <- as.factor(1:3)
names(locations) <- paste0("Location ", 1:3)

adour_sites$"location" <- factor(adour_sites$"location", levels = 1:3,
                                 labels = paste0("Location ", 1:3))

ggplot(adour_sites) +
  geom_point(aes(x = transect, y = quadrat), shape = 19, size = 4) +
  scale_x_continuous(breaks = seq(1, 3, by = 1)) +
  xlab("Transect") + ylab("Quadrat") +
  theme_light() +
  theme(axis.title       = element_text(family = "serif", face = "bold", 
                                        size = 16),
        axis.text        = element_text(family = "serif", face = "bold", 
                                        size = 14),
        axis.ticks       = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = NA),
        strip.text       = element_text(family = "serif", face = "bold", 
                                        size = 18, color = "black"),
        panel.spacing    = unit(4, "lines")) +
  facet_wrap(. ~ location, scales = "free")

adour_sites$"location" <- as.character(adour_sites$"location")
adour_sites$"location" <- gsub("Location ", "", adour_sites$"location")
adour_sites$"location" <- as.numeric(adour_sites$"location")
```


\

From this figure, several things should be noted:

1. For two-dimensional networks, the x-axis **always** corresponds to transects
and the y-axis to the quadrats.
2. In this survey, the locations have the same transect identifiers (1 to 3) 
but the **identifier of quadrats increases** with locations.
3. The **order of the quadrats** follows the direction of the network: the first 
quadrat is upstream and the last is downstream. 


\


When using the package `chessboard`, the **first step** is to create **nodes labels**
by combining the identifiers of transects and quadrats. It's the purpose of the
function `create_nodes_labels()`.


\


```{r 'nodes-labels'}
## Create nodes labels ----
adour_sites <- create_nodes_labels(data     = adour_sites, 
                                   location = "location",
                                   transect = "transect", 
                                   quadrat  = "quadrat")

head(adour_sites, 20)
```

\
\
\
\
\
\


### NOTES


Let's import the **Adour river** spatial layer.

This layer is an [`sf`](https://cran.r-project.org/package=sf) spatial object 
of type `LINESTRING` and contains one single row (geometry) defined in the 
[RGF93 / Lambert-93](https://epsg.io/2154) projection.


Let's convert this `data.frame` into an `sf` object of type `POINT`.

```{r 'df-to-sf', fig.height=10, fig.width=12}
## Convert data.frame to sf object ----
adour_sites_sf <- sf::st_as_sf(adour_sites, coords = c("longitude", "latitude"),
                               crs = "epsg:2154")

head(adour_sites_sf)
```

**Note:** The package `chessboard` expects that each site is one row in this object
and its geometry is `POINT` (other geometry like `MUTLIPOINT`, `POLYGON`, etc.)
are not implemented.




## References

Bivand R. _et al._ (2022) spdep: Spatial dependence, weighting schemes, and statistics.
R package version 1.2-4, 
[https://CRAN.R-project.org/package=spdep](https://CRAN.R-project.org/package=spdep).

Blanchet F. G., Legendre P. & Borcard D. (2008) Modelling directional spatial 
processes in ecological data. **Ecological Modelling**, 215, 325-336. 
doi: [10.1016/j.ecolmodel.2008.04.001](https://doi.org/10.1016/j.ecolmodel.2008.04.001).

Dray S., Legendre P. & Peres-Neto P. R. (2006) Spatial modelling: a comprehensive 
framework for principal coordinate analysis of neighbour matrices (PCNM).
**Ecological Modelling**, 196, 483-493. 
doi: [10.1016/j.ecolmodel.2006.02.015](https://doi.org/10.1016/j.ecolmodel.2006.02.015).

Dray S. _et al._ (2022) adespatial: Multivariate Multiscale Spatial Analysis. 
R package version 0.3-16, 
[https://CRAN.R-project.org/package=adespatial](https://CRAN.R-project.org/package=adespatial).
